<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Retail Shop Pro</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="dashboard-grid">
        <!-- Mobile Menu Button -->
        <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleMobileMenu()">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="navbar-brand" style="margin-bottom: 2rem;">üõí Retail Shop</div>

            <ul class="sidebar-menu">
                <li class="sidebar-item">
                    <a href="#dashboard" class="sidebar-link active" onclick="showSection('dashboard')">
                        üìä Dashboard
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="#products" class="sidebar-link" onclick="showSection('products')">
                        üì¶ Products
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="#billing" class="sidebar-link" onclick="showSection('billing')">
                        üßæ Billing
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="#reports" class="sidebar-link" onclick="showSection('reports')">
                        üìà Reports
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="#settings" class="sidebar-link" onclick="showSection('settings')">
                        ‚öôÔ∏è Settings
                    </a>
                </li>
            </ul>

            <div style="margin-top: auto; padding-top: 2rem; border-top: 1px solid var(--glass-border);">
                <p style="font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem;" id="userDisplay"></p>
                <button class="btn btn-outline" style="width: 100%;" onclick="Auth.logout()">Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Section -->
            <section id="dashboard" class="content-section">
                <h1>Dashboard</h1>
                <p class="text-muted mb-3">Overview of your retail shop</p>

                <div class="grid grid-4 mb-4">
                    <div class="stat-card">
                        <div class="stat-value" id="dashTotalProducts">0</div>
                        <div class="stat-label">Total Products</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="dashLowStock">0</div>
                        <div class="stat-label">Low Stock Items</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="dashTodaySales">‚Çπ0</div>
                        <div class="stat-label">Today's Sales</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="dashTotalBills">0</div>
                        <div class="stat-label">Total Bills Today</div>
                    </div>
                </div>

                <div class="grid grid-2">
                    <div class="glass-card">
                        <h3>Low Stock Alerts</h3>
                        <div id="dashLowStockList"></div>
                    </div>
                    <div class="glass-card">
                        <h3>Recent Bills</h3>
                        <div id="dashRecentBills"></div>
                    </div>
                </div>
            </section>

            <!-- Products Section -->
            <section id="products" class="content-section hidden">
                <div class="flex-between mb-3">
                    <div>
                        <h1>Product Management</h1>
                        <p class="text-muted">Manage your inventory</p>
                    </div>
                    <button class="btn btn-primary" onclick="ProductManager.showAddProductModal()">
                        + Add Product
                    </button>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Product Name</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>GST Rate</th>
                                <th>HSN Code</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody"></tbody>
                    </table>
                </div>
            </section>

            <!-- Billing Section -->
            <section id="billing" class="content-section hidden">
                <h1>Quick Billing</h1>
                <p class="text-muted mb-3">Create invoices quickly</p>

                <div class="glass-card text-center" style="padding: 3rem;">
                    <p style="font-size: 3rem; margin-bottom: 1rem;">üßæ</p>
                    <h3>Billing Interface</h3>
                    <p class="text-muted mb-3">Use the dedicated billing page for a better experience</p>
                    <div class="flex gap-2 justify-center" style="display: flex; gap: 0.5rem; justify-content: center;">
                        <a href="billing.html" class="btn btn-primary">GST Billing</a>
                        <a href="estimate.html" class="btn btn-outline">Estimate Billing</a>
                    </div>
                </div>
            </section>

            <!-- Reports Section -->
            <section id="reports" class="content-section hidden">
                <h1>Reports & Analytics</h1>
                <p class="text-muted mb-3">View detailed business reports</p>

                <!-- Date Range Selector -->
                <div class="glass-card mb-3">
                    <div class="flex gap-2" style="align-items: flex-end; flex-wrap: wrap;">
                        <div class="form-group" style="flex: 1; min-width: 200px; margin-bottom: 0;">
                            <label class="form-label">From Date</label>
                            <input type="date" class="form-input" id="reportStartDate">
                        </div>
                        <div class="form-group" style="flex: 1; min-width: 200px; margin-bottom: 0;">
                            <label class="form-label">To Date</label>
                            <input type="date" class="form-input" id="reportEndDate">
                        </div>
                        <div class="form-group" style="flex: 1; min-width: 200px; margin-bottom: 0;">
                            <label class="form-label">Filter Bills</label>
                            <select class="form-input" id="reportTypeFilter">
                                <option value="ALL">All Bills</option>
                                <option value="GST">GST Bills Only</option>
                                <option value="ESTIMATE">Estimates Only</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1; min-width: 200px; margin-bottom: 0;">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-primary" style="width: 100%;" onclick="loadReports()">
                                Generate Reports
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Report Tabs -->
                <div class="flex gap-2 mb-3">
                    <button class="btn btn-primary" onclick="showReportTab('sales')">Sales Report</button>
                    <button class="btn btn-outline" onclick="showReportTab('stock')">Stock Report</button>
                    <button class="btn btn-outline" onclick="showReportTab('gst')">GST Report</button>
                </div>

                <!-- Sales Report -->
                <div id="salesReport" class="report-tab">
                    <div class="grid grid-4 mb-3">
                        <div class="stat-card">
                            <div class="stat-value" id="totalBills">0</div>
                            <div class="stat-label">Total Bills</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalSales">‚Çπ0</div>
                            <div class="stat-label">Total Sales</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalGST">‚Çπ0</div>
                            <div class="stat-label">Total GST</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="netSales">‚Çπ0</div>
                            <div class="stat-label">Net Sales</div>
                        </div>
                    </div>

                    <div class="glass-card">
                        <div class="flex-between mb-3">
                            <h3>Sales Details</h3>
                            <button class="btn btn-success"
                                onclick="ReportsManager.exportSalesReport(document.getElementById('reportStartDate').value, document.getElementById('reportEndDate').value, document.getElementById('reportTypeFilter').value)">
                                Export CSV
                            </button>
                        </div>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Invoice No</th>
                                        <th>Date</th>
                                        <th>Customer</th>
                                        <th>Items</th>
                                        <th>Subtotal</th>
                                        <th>GST</th>
                                        <th>Total</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="salesTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Stock Report -->
                <div id="stockReport" class="report-tab hidden">
                    <div class="grid grid-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-value" id="totalProducts">0</div>
                            <div class="stat-label">Total Products</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalStockValue">‚Çπ0</div>
                            <div class="stat-label">Stock Value</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="lowStockCount">0</div>
                            <div class="stat-label">Low Stock Items</div>
                        </div>
                    </div>

                    <div class="glass-card">
                        <div class="flex-between mb-3">
                            <h3>Stock Details</h3>
                            <button class="btn btn-success" onclick="ReportsManager.exportStockReport()">
                                Export CSV
                            </button>
                        </div>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Product Name</th>
                                        <th>Category</th>
                                        <th>Current Stock</th>
                                        <th>Min Stock</th>
                                        <th>Price</th>
                                        <th>Stock Value</th>
                                    </tr>
                                </thead>
                                <tbody id="stockTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- GST Report -->
                <div id="gstReport" class="report-tab hidden">
                    <div class="glass-card">
                        <div class="flex-between mb-3">
                            <h3>GST Breakdown by Rate</h3>
                            <button class="btn btn-success"
                                onclick="ReportsManager.exportGSTReport(document.getElementById('reportStartDate').value, document.getElementById('reportEndDate').value)">
                                Export CSV
                            </button>
                        </div>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>GST Rate</th>
                                        <th>Taxable Amount</th>
                                        <th>CGST</th>
                                        <th>SGST</th>
                                        <th>IGST</th>
                                        <th>Total GST</th>
                                    </tr>
                                </thead>
                                <tbody id="gstTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings" class="content-section hidden">
                <h1>Settings</h1>
                <p class="text-muted mb-3">Configure your shop details</p>

                <div class="glass-card">
                    <h3>Company Information</h3>
                    <form id="settingsForm" onsubmit="saveSettings(event)">
                        <div class="form-group">
                            <label class="form-label">Company Name</label>
                            <input type="text" class="form-input" id="companyName" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Address</label>
                            <textarea class="form-textarea" id="companyAddress" required></textarea>
                        </div>

                        <div class="grid grid-2">
                            <div class="form-group">
                                <label class="form-label">GSTIN</label>
                                <input type="text" class="form-input" id="companyGSTIN" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">State Code</label>
                                <input type="text" class="form-input" id="companyStateCode" required>
                            </div>
                        </div>

                        <div class="grid grid-2">
                            <div class="form-group">
                                <label class="form-label">Phone</label>
                                <input type="tel" class="form-input" id="companyPhone" required
                                    oninput="this.value = this.value.replace(/[^0-9+\-\s()]/g, '')">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-input" id="companyEmail" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Tamil Blessing (shown on invoices)</label>
                            <textarea class="form-textarea" id="tamilBlessing" rows="2"
                                placeholder="‡Æâ&#10;‡Æ∏‡Øç‡Æ∞‡ØÄ ‡Æ∞‡Ææ‡ÆÆ ‡Æú‡ØÜ‡ÆØ‡ÆÆ‡Øç"></textarea>
                            <p class="text-muted" style="font-size: 0.85rem; margin-top: 0.25rem;">Leave empty to hide
                                the blessing on invoices</p>
                        </div>

                        <button type="submit" class="btn btn-primary">Save Settings</button>
                    </form>
                </div>

                <!-- Data Backup & Restore -->
                <div class="glass-card mt-4">
                    <h3>üîí Data Backup & Security</h3>
                    <p class="text-muted mb-3">Export, import, or clear your application data</p>

                    <div class="grid grid-3 gap-2">
                        <div class="glass-card" style="padding: 1.5rem; text-align: center;">
                            <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üíæ</div>
                            <h4 style="margin-bottom: 0.5rem;">Export Data</h4>
                            <p class="text-muted" style="font-size: 0.9rem; margin-bottom: 1rem;">
                                Download all data as JSON backup file
                            </p>
                            <button class="btn btn-success" style="width: 100%;" onclick="exportBackup()">
                                Export Backup
                            </button>
                        </div>

                        <div class="glass-card" style="padding: 1.5rem; text-align: center;">
                            <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üì•</div>
                            <h4 style="margin-bottom: 0.5rem;">Import Data</h4>
                            <p class="text-muted" style="font-size: 0.9rem; margin-bottom: 1rem;">
                                Restore data from backup file
                            </p>
                            <input type="file" id="importFile" accept=".json" style="display: none;"
                                onchange="importBackup(this)">
                            <button class="btn btn-primary" style="width: 100%;"
                                onclick="document.getElementById('importFile').click()">
                                Import Backup
                            </button>
                        </div>

                        <div class="glass-card"
                            style="padding: 1.5rem; text-align: center; border: 1px solid var(--danger);">
                            <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">‚ö†Ô∏è</div>
                            <h4 style="margin-bottom: 0.5rem;">Clear Data</h4>
                            <p class="text-muted" style="font-size: 0.9rem; margin-bottom: 1rem;">
                                Reset all data to defaults
                            </p>
                            <button class="btn btn-danger" style="width: 100%;" onclick="clearAllData()">
                                Clear All Data
                            </button>
                        </div>
                    </div>

                    <div class="mt-3"
                        style="padding: 1rem; background: rgba(0, 242, 254, 0.1); border-radius: var(--radius-md); border-left: 4px solid var(--success);">
                        <p style="margin: 0; font-size: 0.9rem; color: var(--text-secondary);">
                            <strong>üí° Tip:</strong> Regularly export your data to prevent data loss. The backup file
                            contains all products, bills, users, and settings.
                        </p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script src="js/database.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/products.js"></script>
    <script src="js/billing.js"></script>
    <script src="js/pdf.js"></script>
    <script src="js/reports.js"></script>
    <script>
        // Check admin authentication
        Auth.requireAdmin();

        // Display user info
        const user = Auth.getCurrentUser();
        document.getElementById('userDisplay').textContent = user.name;

        // Section navigation
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });

            // Remove active class from all links
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('active');
            });

            // Show selected section
            document.getElementById(sectionId).classList.remove('hidden');

            // Add active class to clicked link
            event.target.classList.add('active');

            // Close mobile sidebar if open
            const sidebar = document.getElementById('sidebar');
            const menuBtn = document.getElementById('mobileMenuBtn');
            if (sidebar && sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
                if (menuBtn) menuBtn.classList.remove('active');
            }

            // Load section data
            if (sectionId === 'dashboard') loadDashboard();
            if (sectionId === 'products') ProductManager.renderProductsTable();
            if (sectionId === 'reports') initReports();
            if (sectionId === 'settings') loadSettings();
        }


        // Load dashboard
        async function loadDashboard() {
            const products = await DB.getProducts();
            const lowStock = await DB.getLowStockProducts();
            const today = getTodayDate();
            const todayBills = await DB.getBillsByDateRange(today, today);

            let todaySales = 0;
            todayBills.forEach(bill => todaySales += bill.total);

            document.getElementById('dashTotalProducts').textContent = products.length;
            document.getElementById('dashLowStock').textContent = lowStock.length;
            document.getElementById('dashTodaySales').textContent = formatCurrency(todaySales);
            document.getElementById('dashTotalBills').textContent = todayBills.length;

            // Low stock list
            await ProductManager.renderLowStockAlerts('dashLowStockList');

            // Recent bills
            const recentBills = todayBills.slice(-5).reverse();
            const billsHTML = recentBills.length > 0 ? recentBills.map(bill => `
        <div class="glass-card" style="padding: 1rem; margin-bottom: 0.5rem;">
          <div class="flex-between">
            <div>
              <strong>${bill.invoiceNo}</strong>
              <p class="text-muted" style="margin: 0; font-size: 0.9rem;">${bill.customerName}</p>
            </div>
            <strong>${formatCurrency(bill.total)}</strong>
          </div>
        </div>
      `).join('') : '<p class="text-muted">No bills today</p>';

            document.getElementById('dashRecentBills').innerHTML = billsHTML;
        }

        // Initialize reports
        function initReports() {
            const today = getTodayDate();
            document.getElementById('reportStartDate').value = today;
            document.getElementById('reportEndDate').value = today;
            loadReports();
        }

        // Load reports
        async function loadReports() {
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const filterType = document.getElementById('reportTypeFilter').value;

            await ReportsManager.renderSalesReport(startDate, endDate, filterType);
            await ReportsManager.renderStockReport();
            await ReportsManager.renderGSTReport(startDate, endDate);
        }

        // Show report tab
        function showReportTab(tabName) {
            document.querySelectorAll('.report-tab').forEach(tab => tab.classList.add('hidden'));
            document.getElementById(tabName + 'Report').classList.remove('hidden');

            // Update button styles
            event.target.parentElement.querySelectorAll('.btn').forEach(btn => {
                btn.className = 'btn btn-outline';
            });
            event.target.className = 'btn btn-primary';
        }

        // Load settings
        async function loadSettings() {
            const settings = await DB.getSettings();
            document.getElementById('companyName').value = settings.companyName;
            document.getElementById('companyAddress').value = settings.address;
            document.getElementById('companyGSTIN').value = settings.gstin;
            document.getElementById('companyStateCode').value = settings.stateCode;
            document.getElementById('companyPhone').value = settings.phone;
            document.getElementById('companyEmail').value = settings.email;
            document.getElementById('tamilBlessing').value = settings.tamilBlessing || '';
        }

        // Save settings
        async function saveSettings(event) {
            event.preventDefault();

            const settings = {
                companyName: document.getElementById('companyName').value,
                address: document.getElementById('companyAddress').value,
                gstin: document.getElementById('companyGSTIN').value,
                stateCode: document.getElementById('companyStateCode').value,
                phone: document.getElementById('companyPhone').value,
                email: document.getElementById('companyEmail').value,
                tamilBlessing: document.getElementById('tamilBlessing').value
            };

            await DB.updateSettings(settings);
            showToast('Settings saved successfully', 'success');
        }

        // Export backup
        async function exportBackup() {
            try {
                await DB.exportToFile();
                showToast('Backup exported successfully!', 'success');
            } catch (error) {
                showToast('Failed to export backup', 'error');
                console.error(error);
            }
        }

        // Import backup
        async function importBackup(input) {
            const file = input.files[0];
            if (!file) return;

            if (!file.name.endsWith('.json')) {
                showToast('Please select a valid JSON file', 'error');
                return;
            }

            confirmDialog(
                'Importing will replace all current data. Are you sure you want to continue?',
                async () => {
                    try {
                        await DB.importFromFile(file);
                        showToast('Backup imported successfully! Reloading...', 'success');
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } catch (error) {
                        showToast('Failed to import backup: ' + error.message, 'error');
                        console.error(error);
                    }
                }
            );

            // Reset file input
            input.value = '';
        }

        // Clear all data
        async function clearAllData() {
            confirmDialog(
                'This will delete ALL data including products, bills, and settings. This action cannot be undone. Are you sure?',
                async () => {
                    await DB.clearAll();
                    showToast('All data cleared. Reloading...', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1500);
                }
            );
        }

        // Mobile menu toggle
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            const menuBtn = document.getElementById('mobileMenuBtn');
            sidebar.classList.toggle('active');
            menuBtn.classList.toggle('active');
        }

        // Initialize dashboard on load
        loadDashboard();
    </script>
</body>

</html>